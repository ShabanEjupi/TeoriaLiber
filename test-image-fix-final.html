<!DOCTYPE html>
<html lang="sq">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Final Image Fix - No Infinite Loops</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            color: #333;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.success { background: #d1fae5; color: #065f46; }
        .status.error { background: #fee2e2; color: #991b1b; }
        .status.info { background: #dbeafe; color: #1e40af; }
        .test-image img {
            max-width: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin: 10px 5px;
        }
        button:hover {
            background: #1d4ed8;
        }
        .log-output {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîß Test Final Image Fix - Fixed Version</h1>
        <p><strong>This page tests the corrected image-display-fix.js without infinite refresh loops.</strong></p>
        
        <div class="test-section">
            <h2>üß™ Console Monitoring</h2>
            <div id="console-output" class="log-output">Waiting for console output...</div>
            <button onclick="clearConsole()">Clear Console</button>
            <button onclick="testImageRestore()">Test Image Restore</button>
            <button onclick="testForceRestore()">Force Restore (Testing)</button>
        </div>

        <div class="test-section">
            <h2>üìä Test Results</h2>
            <div id="test-results">Initializing...</div>
        </div>

        <div class="test-section">
            <h2>üîç Mock Chapter Test</h2>
            <div id="chapter-content">
                <h2>Kapitulli 1: Fillimi</h2>
                <div class="enhanced-content">
                    ‚ú® K√´tu gjeni p√´rmbajtje t√´ pasuruar me ilustrime profesionale
                </div>
                <p>Test content for chapter...</p>
            </div>
            <div id="chapter-status" class="status info">Ready for testing</div>
        </div>

        <div class="test-section">
            <h2>üñºÔ∏è Image Display Test</h2>
            <div class="test-image">
                <img src="imazhet/Create an elegant book cover for 'Teoria e Loj√´rave Nderi dhe Suksesi'. Feature chess pieces on a marble board with golden Islamic geometric patterns. Include luxury cars (Mercedes, BMW) in the background and traditional A.png" 
                     alt="Test Image" 
                     onload="updateStatus('image-status', 'success', '‚úÖ Image loaded successfully')"
                     onerror="updateStatus('image-status', 'error', '‚ùå Image failed to load')">
            </div>
            <div id="image-status" class="status info">Testing image load...</div>
        </div>

        <div class="test-section">
            <button onclick="window.open('index.html', '_blank')">üìñ Go to Main Book</button>
            <button onclick="window.location.reload()">üîÑ Reload Test</button>
        </div>
    </div>

    <!-- Simple mock chapters object for testing -->
    <script>
        // Create a simple mock for testing
        window.chapters = {
            1: {
                content: `
                    <h2>Kapitulli 1: Fillimi</h2>
                    <div class="enhanced-content">
                        ‚ú® K√´tu gjeni p√´rmbajtje t√´ pasuruar me ilustrime profesionale
                    </div>
                    <p>Test content for chapter...</p>
                `
            }
        };
        
        window.currentChapter = 1;
        
        // Mock showChapter function - with protection against infinite calls
        let showChapterCallCount = 0;
        window.showChapter = function(chapterNum) {
            showChapterCallCount++;
            console.log(`üìñ Mock showChapter called for chapter ${chapterNum} (call #${showChapterCallCount})`);
            updateStatus('chapter-status', 'info', `showChapter called for chapter ${chapterNum} (${showChapterCallCount} times)`);
            
            if (showChapterCallCount > 3) {
                updateStatus('chapter-status', 'error', `‚ö†Ô∏è showChapter called too many times (${showChapterCallCount})! Possible infinite loop.`);
            }
        };

        // Console capturing
        const originalLog = console.log;
        const originalWarn = console.warn;
        const originalError = console.error;
        
        let consoleMessages = [];
        let messageCount = { log: 0, warn: 0, error: 0 };
        
        function captureConsole(level, args) {
            const message = Array.from(args).join(' ');
            const timestamp = new Date().toLocaleTimeString();
            messageCount[level]++;
            consoleMessages.push(`[${timestamp}] [${level.toUpperCase()}] ${message}`);
            updateConsoleDisplay();
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            captureConsole('log', args);
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            captureConsole('warn', args);
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            captureConsole('error', args);
        };

        function updateConsoleDisplay() {
            const output = document.getElementById('console-output');
            if (output) {
                output.innerHTML = consoleMessages.slice(-15).join('<br>');
                output.scrollTop = output.scrollHeight;
            }
        }

        function clearConsole() {
            consoleMessages = [];
            messageCount = { log: 0, warn: 0, error: 0 };
            showChapterCallCount = 0;
            updateConsoleDisplay();
        }

        function updateStatus(elementId, type, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.className = `status ${type}`;
                element.textContent = message;
            }
        }

        function testImageRestore() {
            updateStatus('test-results', 'info', 'Running image restore test...');
            
            if (window.restoreProperImages) {
                const result = window.restoreProperImages();
                updateStatus('test-results', 'success', `Image restore completed. Fixed: ${result} chapters`);
            } else if (window.ImageDisplayFix) {
                const result = window.ImageDisplayFix.forceRestore();
                updateStatus('test-results', 'success', `Image restore completed via ImageDisplayFix. Fixed: ${result} chapters`);
            } else {
                updateStatus('test-results', 'error', 'Image restore functions not found');
            }
        }

        function testForceRestore() {
            updateStatus('test-results', 'info', 'Running force restore test...');
            
            if (window.forceImageRestore) {
                const result = window.forceImageRestore();
                updateStatus('test-results', 'success', `Force restore completed. Fixed: ${result} chapters`);
            } else if (window.ImageDisplayFix && window.ImageDisplayFix.forceRestore) {
                const result = window.ImageDisplayFix.forceRestore();
                updateStatus('test-results', 'success', `Force restore completed via ImageDisplayFix. Fixed: ${result} chapters`);
            } else {
                updateStatus('test-results', 'error', 'Force restore function not found');
            }
        }

        // Initial test and monitoring
        setTimeout(() => {
            console.log('üß™ Test page loaded, monitoring for infinite loops...');
            const startTime = Date.now();
            const initialMessageCount = messageCount.log + messageCount.warn + messageCount.error;
            
            // Monitor for excessive activity
            setTimeout(() => {
                const endTime = Date.now();
                const totalMessages = messageCount.log + messageCount.warn + messageCount.error;
                const newMessages = totalMessages - initialMessageCount;
                const timeElapsed = endTime - startTime;
                
                let status = 'success';
                let message = `‚úÖ Normal activity: ${newMessages} messages in ${timeElapsed}ms, showChapter called ${showChapterCallCount} times`;
                
                if (newMessages > 50 || showChapterCallCount > 3) {
                    status = 'error';
                    message = `‚ö†Ô∏è Excessive activity detected: ${newMessages} messages, ${showChapterCallCount} showChapter calls in ${timeElapsed}ms`;
                } else if (newMessages > 20) {
                    status = 'info';
                    message = `‚ÑπÔ∏è Moderate activity: ${newMessages} messages in ${timeElapsed}ms`;
                }
                
                updateStatus('test-results', status, message);
                
                // Log statistics
                console.log(`üìä Activity Summary: ${messageCount.log} logs, ${messageCount.warn} warnings, ${messageCount.error} errors`);
            }, 5000);
        }, 1000);
    </script>

    <!-- Load our fixed image script -->
    <script src="image-display-fix.js"></script>
</body>
</html>
